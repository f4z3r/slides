= Kubewarden BBL
:author: Jakob Beckmann <jakob.beckmann@ipt.ch>
:date: 2025-05-22
:title-slide-background-image: ../../assets/img/cover-blue-01.png
// general
:no-header-footer:
:icons: font
// theming
:revealjsdir: ../assets/revealjs/base/
:revealjs_customTheme: ../assets/revealjs/themes/ipt.css
:customcss: ./style.css
:source-highlighter: highlightjs
:highlightjs-theme: ../assets/revealjs/themes/highlightjs-github-dark.css
// options
:revealjs_history: false
:revealjs_overview: true
:revealjs_controls: false
:revealjs_hash: true
:revealjs_fragmentInURL: true
:revealjs_showSlideNumber: speaker
:revealjs_autoPlayMedia: true
:revealjs_transitionSpeed: fast
// view options
:revealjs_viewDistance: 5
:revealjs_width: 2550
:revealjs_height: 1440
:revealjs_margin: 0.1
:revealjs_center: false
:revealjs_disableLayout: false
// content
:imagesdir: images
// :iconfont-remote!:
// :iconfont-name: fonts/fontawesome/css/all

[.center.uppercase.x-large]
== Policy Engines

=== RBAC

[.text-center]
image::./standard-k8s-rbac.excalidraw.png[height=1000px]

=== RBAC

[.text-center]
image::./rbac-k9s.png[]

[.columns]
====
[.column.boxed]
.Uses:
--
* `+ServiceAccount+`, `+User+`, `+Group+`
* `+Role+`, `+ClusterRole+`
* `+RoleBinding+`, `+ClusterRoleBinding+`
--

[.column.boxed]
.Limitations
--
* Only applied to CRUD operations
* Does not check content
* Only supports basic allow/deny
--
====

[.center%notitle]
=== RBAC

[source, yaml, linenums]
.Sample role definition
----
include::./assets/role.yaml[]
----

[%auto-animate]
=== Policy Engine

[.text-center]
image::./policy-engine-k8s.excalidraw.png[height=1000px]

[.columns%auto-animate]
=== Policy Engine

[.text-center.column]
image::./policy-engine-k8s.excalidraw.png[height=500px]

[.column]
--
* Enabled via *Dynamic Access Control*
* Operator + validating admission webhook
* Access controlled via *Custom Resources*
* Often supports *mutations*
* Works *on top of RBAC*
--

=== Use Cases

[.columns]
====

[.column]
--
Access Control::
* More *granular* control on CRUD operations
* Control resource *internals*

FinOps::
* Block if *cost impact* too high
* Provide cost *estimation* on apply
--

[.column]
--
Compliance::
* Control of *usage* of resources
* *Warn* on non-compliant operations
* *Mutate* resources as needed
--

====

{empty}

[source, console]
.FinOps Example using Gatekeeper and OpenCost
----
$ kubectl apply -f deployment.yaml
Error from server (Forbidden): error when creating "deployment.yaml": admission webhook
"validation.gatekeeper.sh" denied the request:
[monthly-cpu-cost-limit]: Deployment-blocked: Predicted monthly CPU cost $7290.0 exceeds limit $5000.0
Current usage: $6.37/hours ($4590.0/month) using 5.9 cores (based on 13.50 hours of data)
New deployment: 3 (3.0 cores) will cost $2700.0/month
Total predicted: $7290.0/month (Rate: $1.25 per core hour)
----

[%auto-animate]
=== Implementations

{empty} +
{empty}

[.columns]
====
[.column.text-center]
image::./kyverno-logo.png[width=45%]


[.column.text-center]
image::./kubewarden-logo.png[width=45%]

[.column.text-center]
image::./opa-logo.png[width=45%]
====

[.columns]
====
[.column]
.Kyverno
--
* Most Mature
* Nice exception handling
* Does more than access
--

[.column]
.Kubewarden
--
* Most flexible
* Actual policy-as-code
* Complex
--

[.column]
--
.Gatekeeper
* Best integration with OPA
* No mutations
--
====

[%notitle%auto-animate.center]
== Kubewarden

[.text-center]
image::./kubewarden-logo.png[]

== Architecture

[.text-center]
image::./kubewarden-architecture.excalidraw.png[height=1000px]

=== Policy Server

[.text-center]
image::./policy-server-architecture.excalidraw.png[height=800px]

== Custom Resource

[source, yaml, linenums]
.ClusterAdmissionPolicy
----
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  annotations:
    io.kubewarden.policy.category: PSP <1>
    io.kubewarden.policy.severity: medium <1>
  name: privileged-pods
----
<1> Custom annotation to control reporting, etc.

== Custom Resource

[source, yaml, linenums]
.ClusterAdmissionPolicy
----
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: privileged-pods
spec:
  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v1.0.0 <1>
  settings: {} <2>
----
<1> WASM module to use to evaluate the policy.
<2> Settings to pass to the module.

== Custom Resource

[source, yaml, linenums]
.ClusterAdmissionPolicy
----
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: privileged-pods
spec:
  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v1.0.0
  mutating: false <1>
  policyServer: default <2>
  backgroundAudit: true <3>
----
<1> The policy does not modify the request.
<2> The policy should be deployed to the `+default+` policy server.
<3> This policy should be considered by the audit scanner.

== Custom Resource

[source, yaml, linenums]
.ClusterAdmissionPolicy
----
apiVersion: policies.kubewarden.io/v1
kind: ClusterAdmissionPolicy
metadata:
  name: privileged-pods
spec:
  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v1.0.0
  rules: <1>
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - pods
----
<1> On what Kubernetes API requests to trigger the policy.

[.center]
== !

[.x-large]
https://github.com/iptch/kubewarden-demo

[.columns]
== Verdict

[.column.boxed]
.Pros
--
* Immense flexibility
* Extremely fast policy evaluation
* Can be adopted slowly
--

[.column.boxed]
.Cons
--
* Complex
* Not as established as Kyverno
* More difficult to get support
--
